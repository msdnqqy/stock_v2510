import ollama
import json
import re

# 实验结果： https://www.yuque.com/g/u21187361/eakfyp/oprwk6b1p7tkkewl/collaborator/join?token=bq4jCYMk6Pre5ufL&source=doc_collaborator# 《因果关系提取-v1112-few shot版》

# --- 1. 推荐模型 ---
# 14B 模型对于“遵循 CoT + JSON”指令的能力远胜 8B
# MODEL_NAME = "deepseek-r1:14b"  # 确保您已导入或 'ollama pull qwen1.5:14b'
# MODEL_NAME = "deepseek-r1:8b"  # 确保您已导入或 'ollama pull qwen1.5:14b'
# MODEL_NAME = "gemma3:27b-it-qat"  # https://ollama.com/library/gemma3
MODEL_NAME = "gemma3:12b-it-qat"  # https://ollama.com/library/gemma3
# MODEL_NAME = "qwen3:8b"  # 确保您已导入或 'ollama pull qwen1.5:14b'
# MODEL_NAME = "qwen3:14b"  # 确保您已导入或 'ollama pull qwen1.5:14b'
# MODEL_NAME = "qwen3:30b"  # 确保您已导入或 'ollama pull qwen1.5:14b'

# --- 2. 示例新闻 (模拟输入) ---
# NEWS_ARTICLE = """
# 金融时报 11 月 14 日报道，全球咖啡连锁巨头“星辰咖啡” (StarCoffee) 
# 发布了其第三季度财报，净利润同比下降 15%，远低于市场预期。
# 公司 CEO 将此归咎于两大因素：
# 首先，巴西（全球最大的咖啡豆供应国）的意外霜冻灾害，导致咖啡豆采购成本飙升 30%；
# 其次，由于“清洁标签”倡议的推行，公司全面更换包装材料，导致一次性运营成本增加了 5000 万美元。
# 财报发布后，“星辰咖啡”的股价在纽约证交所暴跌 12%。
# """

NEWS_ARTICLE = """
宏观行业新闻

●中国人民银行召开党的二十届四中全会精神宣讲报告会。央行行长潘功胜指出，完善中央银行制度是“十五五”时期推动金融高质量发展、加快建设金融强国的战略举措。要坚持党中央对金融工作的集中统一领导，纵深推进全面从严治党，全面贯彻全会部署，深入研究谋划“十五五”时期中国人民银行重点工作，构建科学稳健的货币政策体系，健全覆盖全面的宏观审慎管理体系和系统性金融风险防范处置机制，持续深化金融供给侧结构性改革，稳步推进金融高水平开放，坚决维护国家金融安全。
●国家发展改革委起草了《国家新兴产业创新中心管理办法（征求意见稿）》《国家产业技术工程化中心管理办法（征求意见稿）》，现向社会公开征求意见。《国家新兴产业创新中心管理办法（征求意见稿）》指出，支持产业创新中心研发的首台套重大技术装备、首批次新材料、首版次高端软件优先纳入政府绿色采购清单。产业创新中心应依法采购本国仪器设备、工业软件、操作系统等。国家发展改革委依据运行评价结果，组织产业创新中心申请国家后补助资金支持。鼓励金融机构、投资基金和其他社会资本投资产业创新中心，鼓励企业和企业家捐助产业创新中心建设和运行。
●随着我国资本市场高水平制度型开放不断拓展，境外投资者持有A股的市值，从2020年底的超3万亿元增长到目前的超3.5万亿元。中国证监会副主席李明表示：目前境外投资者持有A股的市值超过3.5万亿元，是A股市场的重要参与力量。展望未来，中国资本市场对外开放的大门只会越来越大。推动更多期货期权品种纳入对外开放品种范围，提高外资机构参与中国资本市场的便利度。
●工信部部长李乐成出席2025专精特新中小企业发展大会并调研专精特新“小巨人”企业。李乐成指出，工信部将与各方一道，把优质企业梯度培育作为发展新质生产力、推进新型工业化、构建现代化产业体系的重要抓手和关键支撑，进一步抓实抓好。强化企业创新主体地位。在企业布局建设更多国家级创新平台，探索建设专精特新赋能中心，推动创新链和产业链无缝对接。
●国家金融监督管理总局党委书记、局长李云泽会见安达集团董事长兼首席执行官埃文·格林伯格一行。双方就中国保险业和资管业前景、安达集团在华发展情况等议题进行交流。
●国家邮政局监测数据显示，10月21日至11月11日，全国邮政快递企业共揽收快递包裹139.38亿件，其间日均揽收量达6.34亿件，是日常业务量的117.8%。旺季单日业务量峰值达7.77亿件，刷新单日业务量纪录。快递市场规模持续扩张，展现了邮政快递业对促进消费升级和实体经济增长的关键支撑作用。
●据交通运输部网约车监管信息交互系统监测，截至10月31日，全国共有393家网约车平台公司取得网约车平台经营许可，环比持平。网约车监管信息交互系统10月份共收到订单信息8.92亿单。其中，面向乘客、与网约车平台公司共同提供服务的平台（俗称网约车聚合平台）完成2.77亿单，环比增长6.7%。
●推动汽车安全行驶，相关部门正在行动。根据国家标准化管理委员会标准制修订计划，公安部组织完成了《机动车运行安全技术条件》国家标准的征求意见稿。其中提及限速要求：乘用车每次启动后，应处于百公里加速时间（0～100km/h）不少于5秒的默认状态。聚焦近年来新能源汽车电池起火事件，《条件》提出安全要求：纯电动汽车、插混汽车应具有能切断动力电路的功能，当车辆在纵向或横向方向上150ms时间内有不小于25km/h的速度变化或不可逆约束装置展开时，应能自动切断动力电路。
●2025世界动力电池大会签约仪式在四川宜宾成功举行，共签约项目180个，总金额达861.3亿元，涵盖动力电池、新型储能、光伏、智能网联新能源汽车等绿色新能源关键领域，展现出强劲的产业集聚效应与发展动能。项目全面投产后，预计年产值突破900亿元、年税收贡献超50亿元、新增就业岗位近3万个。龙头引领与投资体量双重突破，大会吸引超50家龙头企业落户宜宾，涵盖上市公司、高新技术企业、专精特新企业与瞪羚企业，10亿元以上重大项目达26个，签约金额占总金额近50%。
●乘联分会数据显示，11月1-9日，全国乘用车新能源市场零售26.5万辆，同比去年11月同期下降5%，较上月同期增长16%，今年以来累计零售1,041.5万辆，同比增长21%；11月1-9日，全国乘用车厂商新能源批发30.6万辆，同比去年11月同期下降3%，较上月同期增长59%，今年以来累计批发1,236.2万辆，同比增长29%。
●近日，首个具备“万辆级”产能的电动垂直起降飞行汽车工厂在广州进入试产阶段，这标志着在低空经济领域，该类产品在国内首次进入规模化制造环节。待完成相关验证与适航取证后，工厂将按照规划逐步进入量产，实现飞行汽车从“小批量验证”迈向“规模化制造”的跨越。
股市新闻

●上交所理事长邱勇在2025年上海证券交易所国际投资者大会上发表题为《价值引领 开放赋能 共创资本市场新未来》的致辞。邱勇表示，“十五五”时期是基本实现社会主义现代化夯实基础、全面发力的关键时期，上交所将以更加开放、包容的市场生态，更加多元、丰富的产品体系，更加高效、便捷的服务能力，为全球投资者拓展更为广阔的跨境投资机遇。
●截至11月11日，今年以来全市场新发基金数量已达1371只，创近三年新高。新基金平均募集规模仅为7.82亿元，这一“数量增+平均规模减”的现象，勾勒出2025年公募基金发行市场的深刻变局。年内公募基金发行市场已从依靠明星基金经理和爆款单品驱动的模式，彻底转向了以“工具化、细分化、机构化”为特征的“广撒网”新阶段。今年基金发行呈现“权益走强、债基降温”态势，股票型基金以761只的发行量创下历史纪录，较2024年全年大增62%，债券型基金发行数量仅247只，创近十年新低。
●受“晶澳科技高管在光伏月度例会表态”相关市场消息影响，光伏板块回调明显。对此，通威股份相关负责人回应称，公司坚定看好和支持光伏“反内卷”行动，坚信相关政策必将逐步落地实施，并将积极配合和支持各项工作的展开。
●A股光伏板块遭遇大面积回调。这场突如其来的下跌，或源于一则市场传闻有关。今日市场有传闻称，“硅料和组件联盟公司被有关部门否了”，更有消息称晶澳科技高管在券商交流中表示“收储平台黄了”。对此，晶澳科技工作人员明确表示，公司并无高管说过“收储平台黄了”一事，该传闻属谣言。对于收储平台事宜，该工作人员补充道，晶澳科技并非该平台参与方，具体落实的细节并不清楚。
●北大医药公告称，公司董事长、总裁徐晰人因涉嫌刑事犯罪已被重庆市江北区人民检察院批准逮捕。目前公司董事陈岳忠代为行使董事长职责，常务副总裁余孟川代为行使总裁及法定代表人职责，公司控制权未发生变化，董事会运作及生产经营正常。
●万科A公告，已完成“20万科08”的赎回工作，本期债券将于11月13日摘牌。公司本期债券赎回金额为16亿元，同时兑付利息金额为6576万元。公司已将赎回本金及利息足额划付至中国结算深圳分公司指定的银行账户。本期债券的赎回不会对公司造成实质不利影响。
●ST中迪公告称，公司股票自10月16日至11月12日价格涨幅为153.19%，连续3个交易日收盘价格涨幅偏离值累计达到16.24%，属于股票交易异常波动。为维护投资者利益，公司股票自11月13日起停牌核查，预计停牌时间不超过3个交易日。
●旷达科技公告称，控股股东沈介良拟以5.39元/股向株洲启创转让411,834,831股（占总股本28%），交易价款合计2,219,789,739.09元，公司控制权将变更为株洲市国资委。近日收到国家市场监督管理总局《经营者集中反垄断审查不实施进一步审查决定书》，该交易已获反垄断审查通过。
●稳健医疗公告称，公司全资子公司深圳全棉时代科技有限公司拟投资约20亿元建设全棉水刺无纺布系列产品生产基地项目，项目用地面积约1000亩，主要建设年产2万吨水刺无纺布、水刺棉等产品生产基地。
●百济神州-U发布三季报，前三季度营业收入275.95亿元，同比增长44.21%；归属于母公司所有者的净利润11.39亿元，上年同期净亏损36.87亿元，扭亏为盈。第三季度营业收入100.77亿元，同比增长41.14%；归属于母公司所有者的净利润6.89亿元，上年同期净亏损8.09亿元，扭亏为盈。
●凯格精机公告称，公司收到总经理邓迪的通知，因涉嫌危险驾驶，邓迪可能判处管制、拘役或者独立适用附加刑，根据《中华人民共和国刑事诉讼法》，东莞市公安局决定对其取保候审，邓迪先生目前可正常履职。
●*ST广道公告称，收到北京证券交易所出具的《关于深圳市广道数字技术股份有限公司股票终止上市的决定》，北京证券交易所决定公司股票终止上市。
●*ST炼石公布重整计划，拟以现有总股本873,100,876股为基数，按每10股转增5.99股的比例实施资本公积转增股本，共计转增522,987,424股。转增股票中2亿股由重整投资人支付12.38亿元现金受让，剩余322,987,424股用于抵偿债务。有财产担保债权和普通债权均将获得100%清偿。
●ST易购公告称，公司及子公司苏宁国际、荷兰控股公司与沈阳家安有福商业有限公司、长沙客优仕超市有限责任公司分别达成债权债务重组，签订《债权债务重组协议书》。《债权债务重组协议书》履行完毕后，公司预计将增加利润总额约5.6亿元。
海外新闻

●美国财长贝森特表示，特朗普政府即将在未来几天公布“实质性”关税消息，并计划对咖啡、香蕉等商品实施关税减免。贝森特还表示，政府正在讨论向年收入低于10万美元的家庭提供2000美元退税的“关税红利”计划，但尚未做出最终决定。他重申，"大规模"税收退款将在2026年初到来。
●欧佩克预计2026年石油市场将实现供需平衡，进一步摒弃供应短缺的预测。欧佩克维持2026年全球石油需求增长预测不变，仍为每日138万桶。欧佩克预测，到2026年，全球对欧佩克+原油的需求将平均达到每日4300万桶（较此前预测减少10万桶/日）。欧佩克月报显示，尽管欧佩克+达成了增产协议，但10月欧佩克+原油日均产量平均为4302万桶，较9月减少7.3万桶。2025年全球原油需求增速预测为130万桶/日。
●欧洲央行执委Schnabel：经济比预期更有韧性；食品价格通胀仍然相当强劲；通胀风险略微上行；利率“绝对”处于良好状态。
●美国截至11月7日当周MBA30年期固定抵押贷款利率为6.34%，前值6.31%；申请活动指数为334.2，前值332.3；购买指数为172.7，前值163.3；再融资活动指数为1247.5，前值1290.8。
●针对重新上市事项，瑞幸方面相关人士回应称，瑞幸咖啡会持续关注美国资本市场，但公司目前对于重返主板上市没有确定的时间表，现阶段的首要任务仍是践行公司的业务战略、聚焦发展。此前，在厦门市政府主办的一场活动上，瑞幸咖啡联合创始人兼行政总裁郭谨一公开表示，公司正在厦门市政府指导下积极推进在美国主板重新上市的进程
"""

# 预期输出如下：
"""
{
  "summary": "全球咖啡连锁巨头“星辰咖啡” (StarCoffee) 报告其第三季度净利润同比下降 15%，低于预期。CEO 将此归咎于巴西霜冻灾害导致咖啡豆成本飙升 30%，以及更换包装材料导致运营成本增加 5000 万美元。财报发布后，公司股价暴跌 12%。",
  "causal_events": [
    {
      "event": "巴西的意外霜冻灾害",
      "subject": "咖啡豆采购成本",
      "effect": "负面影响 (对公司而言)，飙升 30%"
    },
    {
      "event": "“清洁标签”倡议推行，公司全面更换包装材料",
      "subject": "一次性运营成本",
      "effect": "负面影响 (对公司而言)，增加了 5000 万美元"
    },
    {
      "event": "成本飙升和运营成本增加",
      "subject": "第三季度净利润",
      "effect": "负面影响，同比下降 15%，远低于市场预期"
    },
    {
      "event": "发布第三季度财报 (净利润下降)",
      "subject": "“星辰咖啡”的股价",
      "effect": "负面影响，暴跌 12%"
    }
  ]
}
"""


# --- 3. 构建“主提示” (Master Prompt with CoT) ---
def create_master_prompt_with_cot(article):
    # 这是我们上面设计的模板
    return f"""
        你是一个专业的财经新闻分析师。你的任务是分两步完成分析，**思考过程和最终输出都必须提供**。

        **步骤 1: 思考 (Think)**
        在一个 `<think>` XML 标签中，请你先进行“思维链”分析：
        1.  **摘要分析**: 识别出新闻中的所有关键主体（公司、人物）、关键事件、关键数据（数字、百分比、金额）和地点。
        2.  **因果分析**: 寻找文中的因果关系。寻找“A 导致 B”的明确表述（例如：由于...导致...，因此...，结果是...）。明确 A (事件) 和 B (主体/影响)。

        **步骤 2: 输出 (Output)**
        在你的思考分析完成后，请根据你在 `<think>` 标签中的分析结果，严格按照以下的 JSON 格式输出：

        {{
          "summary": "（根据步骤 1 的摘要分析，生成包含所有关键信息的摘要）",
          "causal_events": [
            {{
              "event": "（根据步骤 1 的因果分析，填入【事件】）",
              "subject": "（根据步骤 1 的因果分析，填入【主体】）",
              "effect": "（根据步骤 1 的因果分析，填入【影响内容】）"
            }}
          ]
        }}

        ### 指南
        * 如果新闻中没有因果关系，`causal_events` 字段应返回空列表 `[]`。
        * 你的最终输出**必须**以 `<think>` 标签开始，然后是 JSON 代码块。


        我会先给你一个完美的示例，然后你必须严格模仿这个示例的格式和质量来完成新任务。

        ---
        ### 完美的分析示例 (One-Shot Example)

        #### 示例新闻正文:
        路透社 11 月 12 日报道，由于北海主要油田“巨魔 B”平台发生意外停电，
        运营商 Equinor 宣布该油田（日产 30 万桶）将临时关闭。
        此消息一出，国际原油价格应声上涨，布伦特原油期货价格飙升 4.5%，
        突破每桶 90 美元大关。分析师担心，此次停产将加剧全球能源供应的紧张局势。

        #### 示例分析开始:
        <think>
        1.  **摘要分析**:
            * 主体: 路透社, Equinor, 分析师
            * 地点: 北海, "巨魔 B" 平台
            * 事件: "巨魔 B" 平台发生意外停电，导致油田临时关闭
            * 数据: 11 月 12 日, 日产 30 万桶, 飙升 4.5%, 突破 90 美元大关
        2.  **因果分析**:
            * 因果链 1: “由于...停电” 导致 “临时关闭”。
            * 因果链 2: “此消息一出” (指关闭) 导致 “国际原油价格应声上涨”。
                * 事件: 油田临时关闭
                * 主体: 国际原油价格 (布伦特原油期货)
                * 影响: 正面 (上涨), 飙升 4.5%, 突破 90 美元
            * 因果链 3: “此次停产” (指关闭) 导致 “加剧...紧张局势”。
                * 事件: 油田停产
                * 主体: 全球能源供应
                * 影响: 负面, 加剧紧张局势
        </think>

        {{
          "summary": "Equinor 运营商宣布，因“巨魔 B”平台意外停电，日产 30 万桶的北海油田将临时关闭。此事件导致布伦特原油期货价格飙升 4.5%，突破 90 美元/桶，加剧了全球能源供应紧张局势。",
          "causal_events": [
            {{
              "event": "北海“巨魔 B”平台意外停电导致油田临时关闭",
              "subject": "国际原油价格 (布伦特原油期货)",
              "effect": "正面影响 (上涨)，飙升 4.5%，突破 90 美元大关"
            }},
            {{
              "event": "“巨魔 B”油田停产",
              "subject": "全球能源供应",
              "effect": "负面影响，加剧了紧张局势"
            }}
          ]
        }}

        ### 新闻正文
        {article}

        Let's think step by step,请一步一步思考，最后给出中文答案。
        ### 分析开始:
        """


# --- 4. 执行推理并解析结果 (更新的解析逻辑) ---
def extract_causal_info_with_cot(article_text):
    print(f"--- 正在使用模型 {MODEL_NAME} 进行 CoT 分析... ---")

    prompt = create_master_prompt_with_cot(article_text)

    try:
        response = ollama.chat(
            model=MODEL_NAME,
            messages=[{'role': 'user', 'content': prompt}],
            options={
                'num_ctx': 8192,
                'temperature': 0.0  # 分析任务用 0.0
            },
            # extra_body={"enable_thinking": True},
        )

        print("\n--- 性能数据 ---")
        total_duration_s = response.get('total_duration', 0) / 1e9
        prompt_tokens = response.get('prompt_eval_count', 0)
        response_tokens = response.get('eval_count', 0)

        print(f"总耗时: {total_duration_s:.2f} 秒")
        print(f"提示 Token: {prompt_tokens}")
        print(f"生成 Token: {response_tokens}")
        if total_duration_s > 0 and response_tokens > 0:
            print(
                f"估算速度: {response_tokens / total_duration_s :.2f} tokens/秒")  # 注意：这个速度不准，因为 total_duration 包括了提示处理

        raw_response = response['message']['content']
        print("--- 模型回复 ---")
        print(raw_response)
        print("\n--- 模型回复end ---")

        # --- 新的解析逻辑 ---
        # 1. 提取 <think> 块
        think_match = re.search(r"<think>(.*?)</think>", raw_response, re.DOTALL)
        think_text = think_match.group(1).strip() if think_match else "No <think> block found."

        # 2. 提取 JSON 块 (它应该在 </think> 之后)
        # 我们查找第一个 { 和最后一个 }
        json_match = re.search(r"\{.*\}", raw_response, re.DOTALL)
        if not json_match:
            # 备用方案：查找 ```json
            if "```json" in raw_response:
                json_string = raw_response.split("```json")[1].split("```")[0]
            else:
                raise ValueError("No JSON block found in the response.")
        else:
            json_string = json_match.group(0)

        parsed_data = json.loads(json_string)

        if parsed_data:
            print("\n--- ✅ 分析成功 ---")

            print("\n【步骤 1: 模型的“思维链”(CoT)】")
            print(think_text)

            print("\n【步骤 2: 最终 JSON 输出】")
            print("\n【目标 1：结构化摘要】")
            print(parsed_data.get("summary"))

            print("\n【目标 2：因果关系提取】")
            print(json.dumps(parsed_data.get("causal_events"), indent=2, ensure_ascii=False))

        return think_text, parsed_data

    except Exception as e:
        print(f"错误：无法解析模型输出或连接 Ollama。 {e}")
        # print(f"原始回复: {raw_response}")
        return None, None


# --- 5. 运行 ---
if __name__ == "__main__":
    think_process, extracted_data = extract_causal_info_with_cot(NEWS_ARTICLE)
